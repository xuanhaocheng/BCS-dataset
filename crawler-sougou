

# -*- coding: utf-8 -*-
import os
import requests
import time
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver import ActionChains
from pyquery import PyQuery as pq
from time import sleep



# 定义一个taobao类
class taobao_infos:

    # 对象初始化
    def __init__(self):
        options = webdriver.ChromeOptions()
        #options.add_experimental_option("prefs", {"profile.managed_default_content_settings.images": 2})  # 不加载图片,加快访问速度
        options.add_experimental_option('excludeSwitches',
                                        ['enable-automation'],)  # 此步骤很重要，设置为开发者模式，防止被各大网站识别出来使用了Selenium
        #options.add_argument("--headless")

        self.browser = webdriver.Chrome(executable_path=chromedriver_path, options=options)
        self.browser.implicitly_wait(5)
        self.wait = WebDriverWait(self.browser, 20)  # 超时时长为10s
    # 模拟向下滑动浏览
    def swipe_down(self, second):
        for i in range(int(second / 0.1)):
            js = "var q=document.documentElement.scrollTop=" + str(300 + 200 * i)
            self.browser.execute_script(js)
            sleep(0.1)
        js = "var q=document.documentElement.scrollTop=100000"
        self.browser.execute_script(js)
        sleep(0.2)

    # 爬取天猫商品数据
    def crawl_good_data(self,url_name):

        #
        url_data = { '别墅':   'https://pic.sogou.com/pics?query=%E5%88%AB%E5%A2%85&mode=1',
                     '建筑工地':   'https://pic.sogou.com/pics?query=%E5%BB%BA%E7%AD%91%E5%B7%A5%E5%9C%B0&w=05009900',
                     '建筑工人':   'https://pic.sogou.com/pics?query=%E5%BB%BA%E7%AD%91%E5%B7%A5%E4%BA%BA&w=05009900',
                     '脚手架':   'https://pic.sogou.com/pics?query=%E8%84%9A%E6%89%8B%E6%9E%B6&w=05009900',
                     '钢筋':   'https://pic.sogou.com/pics?query=%E9%92%A2%E7%AD%8B&w=05009900',
                     '混凝土砌块': 'https://pic.sogou.com/pics?query=%E6%B7%B7%E5%87%9D%E5%9C%9F%E7%A0%8C%E5%9D%97&w=05009900',
                     '安全帽':   'https://pic.sogou.com/pics?query=%E5%AE%89%E5%85%A8%E5%B8%BD&w=05009900',
                     '隧道':   'https://pic.sogou.com/pics?query=%E9%9A%A7%E9%81%93&w=05009900',
                     '螺纹钢筋':   'https://pic.sogou.com/pics?query=%E8%9E%BA%E7%BA%B9%E9%92%A2%E7%AD%8B&w=05009900',
                     '填充墙':   'https://pic.sogou.com/pics?query=%E5%A1%AB%E5%85%85%E5%A2%99&w=05009900',
                     '木结构':   'https://pic.sogou.com/pics?query=%E6%9C%A8%E7%BB%93%E6%9E%84&w=05009900',
                     '混凝土柱':   'https://pic.sogou.com/pics?query=%E6%B7%B7%E5%87%9D%E5%9C%9F%E6%9F%B1&w=05009900',
                     '混凝土梁':   'https://pic.sogou.com/pics?query=%E6%B7%B7%E5%87%9D%E5%9C%9F%E6%A2%81&w=05009900',
                     '角钢':   'https://pic.sogou.com/pics?query=%E8%A7%92%E9%92%A2&w=05009900',
                     '地基':   'https://pic.sogou.com/pics?query=%E5%9C%B0%E5%9F%BA&w=05009900',
                     '桩基':   'https://pic.sogou.com/pics?query=%E6%A1%A9%E5%9F%BA&w=05009900',
                     '挖掘机':   'https://pic.sogou.com/pics?query=%E6%8C%96%E6%8E%98%E6%9C%BA&w=05009900',
                     '推土机':   'https://pic.sogou.com/pics?query=%E6%8E%A8%E5%9C%9F%E6%9C%BA&w=05009900',
                     '商业中心':'https://pic.sogou.com/pics?query=%E5%95%86%E4%B8%9A%E4%B8%AD%E5%BF%83&w=05009900',
                     '塔吊':'https://pic.sogou.com/pics?query=%E5%A1%94%E5%90%8A',
                     '3d打印混凝土':'https://pic.sogou.com/pics?query=3d%E6%89%93%E5%8D%B0%E6%B7%B7%E5%87%9D%E5%9C%9F&statref=top_tag&mode=1&tagQSign=%E6%B7%B7%E5%87%9D%E5%9C%9F,9d3e5be5',
                     '3d打印建筑':'https://pic.sogou.com/pics?query=3d%E6%89%93%E5%8D%B0%E5%BB%BA%E7%AD%91&w=05009900',
                     '3d打印桥梁':'https://pic.sogou.com/pics?query=3d%E6%89%93%E5%8D%B0%E6%A1%A5%E6%A2%81&mode=1',
                     '打桩机':'https://pic.sogou.com/pics?query=%E6%89%93%E6%A1%A9%E6%9C%BA',
                     '工地手推车':'https://pic.sogou.com/pics?query=%E5%B7%A5%E5%9C%B0%E6%89%8B%E6%8E%A8%E8%BD%A6&w=05009900',
                     '工字钢':'https://pic.sogou.com/pics?query=%E5%B7%A5%E5%AD%97%E9%92%A2',
                     '钢绞线':'https://pic.sogou.com/pics?query=%E9%92%A2%E7%BB%9E%E7%BA%BF&w=05009900',
                     '工地标签': 'https://pic.sogou.com/pics?query=%E5%B7%A5%E5%9C%B0%E6%A0%87%E7%AD%BE&w=05009900',
                     '钢丝网': 'https://pic.sogou.com/pics?query=%E9%92%A2%E4%B8%9D%E7%BD%91&w=05009900',
                     '高强度螺栓': 'https://pic.sogou.com/pics?query=%E9%AB%98%E5%BC%BA%E5%BA%A6%E8%9E%BA%E6%A0%93&w=05009900',
                     '方钢': 'https://pic.sogou.com/pics?query=%E6%96%B9%E9%92%A2&w=05009900',
                     'U型钢': 'https://pic.sogou.com/pics?query=U%E5%9E%8B%E9%92%A2&w=05009900',
                     '压路机': 'https://pic.sogou.com/pics?query=%E5%8E%8B%E8%B7%AF%E6%9C%BA&w=05009900',
                     '混凝土拌和汽车': 'https://pic.sogou.com/pics?query=%E6%B7%B7%E5%87%9D%E5%9C%9F%E6%8B%8C%E5%92%8C%E6%B1%BD%E8%BD%A6&w=05009900',
                     '锈蚀钢筋': 'https://pic.sogou.com/pics?query=%E9%94%88%E8%9A%80%E9%92%A2%E7%AD%8B&w=05009900',
                     '工地电梯': 'https://pic.sogou.com/pics?query=%E5%B7%A5%E5%9C%B0%E7%94%B5%E6%A2%AF&mode=1',
                     '预制混凝土板': 'https://pic.sogou.com/pics?query=%E9%A2%84%E5%88%B6%E6%B7%B7%E5%87%9D%E5%9C%9F%E6%9D%BF&w=05009900',
                     '烧结砖': 'https://pic.sogou.com/pics?query=%E7%83%A7%E7%BB%93%E7%A0%96&w=05009900',
                     '薄钢板': 'https://pic.sogou.com/pics?query=%E8%96%84%E9%92%A2%E6%9D%BF&w=05009900',
                     '波纹钢': 'https://pic.sogou.com/pics?query=%E6%B3%A2%E7%BA%B9%E9%92%A2&w=05009900',
                     '瓷砖': 'https://pic.sogou.com/pics?query=%E7%93%B7%E7%A0%96&mode=1',
                     '瓷砖地板': 'https://pic.sogou.com/pics?query=%E7%93%B7%E7%A0%96%E5%9C%B0%E6%9D%BF&w=05009900',
                     '木地板': 'https://pic.sogou.com/pics?query=%E6%9C%A8%E5%9C%B0%E6%9D%BF&w=05009900',
                     '预制楼梯': 'https://pic.sogou.com/pics?query=%E9%A2%84%E5%88%B6%E6%A5%BC%E6%A2%AF&w=05009900',
                     '电梯': 'https://pic.sogou.com/pics?query=%E7%94%B5%E6%A2%AF&w=05009900',
                     '剪力墙': 'https://pic.sogou.com/pics?query=%E5%89%AA%E5%8A%9B%E5%A2%99&w=05009900',
                     '瓦片': 'https://pic.sogou.com/pics?query=%E7%93%A6%E7%89%87',
                     '瓦片房顶': 'https://pic.sogou.com/pics?query=%E7%93%A6%E7%89%87%E6%88%BF%E9%A1%B6&w=05009900',
                     '板瓦': 'https://pic.sogou.com/pics?query=%E6%9D%BF%E7%93%A6&w=05009900',
                     '古代瓦片': 'https://pic.sogou.com/pics?query=%E5%8F%A4%E4%BB%A3%E7%93%A6%E7%89%87&w=05009900',
                     '聚氯乙烯防水卷材': 'https://pic.sogou.com/pics?query=%E8%81%9A%E6%B0%AF%E4%B9%99%E7%83%AF%E9%98%B2%E6%B0%B4%E5%8D%B7%E6%9D%90&w=05009900',
                     'pvc防水卷材': 'https://pic.sogou.com/pics?query=pvc%E9%98%B2%E6%B0%B4%E5%8D%B7%E6%9D%90&w=05009900',
                     '振捣棒':'https://pic.sogou.com/pics?query=%E6%8C%AF%E6%8D%A3%E6%A3%92&w=05009900',
                     '振捣':'https://pic.sogou.com/pics?query=%E6%8C%AF%E6%8D%A3&w=05009900',
                     '建筑工地板房':'https://pic.sogou.com/pics?query=%E5%BB%BA%E7%AD%91%E5%B7%A5%E5%9C%B0%E6%9D%BF%E6%88%BF&w=05009900',
                     '建筑工地彩钢房':'https://pic.sogou.com/pics?query=%E5%BB%BA%E7%AD%91%E5%B7%A5%E5%9C%B0%E5%BD%A9%E9%92%A2%E6%88%BF&w=05009900',
                     '建筑工地活动房':'https://pic.sogou.com/pics?query=%E5%BB%BA%E7%AD%91%E5%B7%A5%E5%9C%B0%E6%B4%BB%E5%8A%A8%E6%88%BF&w=05009900',
                     '': '',
                     '': '',
                     '': '',
                     '': '',

                     }
        if os.path.exists(url_name) ==False:
            os.makedirs(url_name)
        self.browser.get(url_data.get(url_name))

        #建筑https://pic.sogou.com/pics?st=255&from=vr&query=%E5%BB%BA%E7%AD%91&rawQuery=%E5%BB%BA%E7%AD%91
        #古代建筑https://pic.sogou.com/pics?query=%E5%8F%A4%E4%BB%A3%E5%BB%BA%E7%AD%91&w=05009900
        #桥梁https://pic.sogou.com/pics?query=%E6%A1%A5%E6%A2%81&w=05009900
        #科幻建筑https://pic.sogou.com/pics?query=%E7%A7%91%E5%B9%BB%E5%BB%BA%E7%AD%91
        #异形建筑https://pic.sogou.com/pics?query=%E5%BC%82%E5%BD%A2%E5%BB%BA%E7%AD%91&w=05009900
        #图书馆外部https://pic.sogou.com/pics?query=%E5%9B%BE%E4%B9%A6%E9%A6%86%E5%A4%96%E9%83%A8&w=05009900
        #教学楼外部https://pic.sogou.com/pics?query=%E6%95%99%E5%AD%A6%E6%A5%BC%E5%A4%96%E9%83%A8&w=05009900
        #佛塔https://pic.sogou.com/pics?query=%E4%BD%9B%E5%A1%94
        #教学楼
        # 精髓之处，大部分人被检测为机器人就是因为进一步模拟人工操作
        # 模拟人工向下浏览商品，即进行模拟下滑操作，防止被识别出是机器人
        self.swipe_down(150)

        # 获取本页面源代码
        html = self.browser.page_source

        # pq模块解析网页源代码
        doc = pq(html)
        #print(doc)
        name = self.browser.find_elements(By.XPATH,'// *[ @ id = "picPc"] / div / div[2] / div / ul / li/ div / a[1] / img')
        #// *[ @ id = "picPc"] / div / div[2] / div / ul / li[1] / div / a[1] / img
        #//*[@id="picPc"]/div/div[2]/div/ul/li/div/a[1]/img
        #
        #print("name:11", name)
        print("len11", len(name))
        n = 0
        m = 0
        img_list = []

        for item in name:
            m+=1
            if m>=0: #1640
            #print("item.text",item)
                if n%10 == 0:
                    sleep(0.5)
                if n % 100 == 0:
                    print(n)
                try:
                    item.click()
                    self.browser.switch_to.window(self.browser.window_handles[-1])
                    sleep(0.6)


                    try:
                         #print("尝试爬取",n)
                         img_url = self.browser.find_element(By.XPATH,'//*[@id="imgArea"]/div[3]/div/div/a/img').get_attribute("drag-img")   #因为只有find_element才有get_attribute
                         #get_attribute("drag-img")
                    except:
                         #print("爬取失败", n)
                         img_url = None
                    print("{}/m".format(url_name), m)
                    print("img_url", img_url)
                    self.browser.close()
                    sleep(1)
                    self.browser.switch_to.window(self.browser.window_handles[0])

                except:
                    print("遇到广告跳到下一个")
                    img_url = None
                    pass

                if img_url != None and img_url  not in img_list:
                    img_list.append(img_url)
                    with open("{}/%d.jpg".format(url_name)%n,"wb") as file:
                        try:
                            file.write(requests.get(img_url).content)
                        except:
                            pass

                else:
                    n -= 1
                    pass
                n += 1
            print(n)
            print(len(img_list))


        self.browser.close()



if __name__ == "__main__":
    # 使用之前请先查看当前目录下的使用说明文件README.MD
    # 使用之前请先查看当前目录下的使用说明文件README.MD
    # 使用之前请先查看当前目录下的使用说明文件README.MD
    list_url1 = ['工地标签','钢丝网','高强度螺栓','方钢','U型钢','压路机','混凝土拌和汽车']
    list_url = ['瓦片房顶','板瓦','古代瓦片','聚氯乙烯防水卷材','pvc防水卷材']
    for i in list_url:
        chromedriver_path = "D:\我的照片\回家需要看的论文-11/chromedriver.exe"  # 改成你的chromedriver的完整路径地址
        a = taobao_infos()
        a.crawl_good_data(i)   #爬取数据


# //*[@id="imgArea"]/div[3]/div/div/a
# //*[@id="imgArea"]/div[3]/div/div/a/img
# //*[@id="imgArea"]/div[3]/div/div/a/img
#//*[@id="picPc"]/div/div[2]/div/ul/li[1]/div/a[1]/img
